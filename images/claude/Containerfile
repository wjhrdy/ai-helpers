FROM quay.io/fedora/fedora:latest

# Install Node.js, NPM, Python 3, development tools, and RPM tools
RUN dnf install -y nodejs \
	npm \
    python3 \
    python3-devel \
    fedora-packager \
    fedora-review \
    mock \
    rpm-build \
    rpmdevtools \
    curl \
    git \
    make \
    shellcheck \
    which \
    && dnf clean all


RUN echo '[google-cloud-cli]' > /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'name=Google Cloud CLI' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'baseurl=https://packages.cloud.google.com/yum/repos/cloud-sdk-el10-$basearch' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'enabled=1' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'gpgcheck=1' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'repo_gpgcheck=0' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
echo 'gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key-v10.gpg' >> /etc/yum.repos.d/google-cloud-sdk.repo && \
dnf install -y google-cloud-cli && \
dnf clean all

# Install uv for PEP 723 script dependency management
RUN curl -LsSf https://astral.sh/uv/install.sh | UV_INSTALL_DIR="/usr/local/bin/" INSTALLER_NO_MODIFY_PATH=1 sh

# Install OpenShift client (oc)
RUN curl -LsSf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz | tar xzf - -C /usr/local/bin/ oc \
    && chmod +x /usr/local/bin/oc

# Install common Python tools
RUN uv pip install --system --no-cache \
    pytest \
    requests \
    pyyaml \
    ruff \
    tox \
    tox-uv

# Create claude user
RUN useradd -m -u 1000 -s /bin/bash claude

# Copy ai-helpers repository to /opt/ai-helpers
COPY . /opt/ai-helpers
RUN chown -R claude:claude /opt/ai-helpers

# Create Claude configuration directory and copy settings
#   Note: We pre-configure known_marketplaces.json because extraKnownMarketplaces doesn't seem to work in non-interactive mode.
RUN mkdir -p /home/claude/.claude/plugins
COPY ./images/claude/claude-settings.json /home/claude/.claude/settings.json
COPY ./images/claude/known_marketplaces.json /home/claude/.claude/plugins/known_marketplaces.json
RUN chown -R claude:claude /home/claude/.claude

# Switch to claude user
USER claude

# Install Claude Code CLI as the claude user
RUN curl -fsSL https://claude.ai/install.sh | bash

# Copy Claude Code binary to system location and make it available system-wide
USER root
RUN cp /home/claude/.local/bin/claude /usr/bin/claude && \
    chmod +x /usr/bin/claude
USER claude

# Set Claude Code as the default command
ENTRYPOINT ["claude"]
